<!doctype html>
<html>
<head>
    <title>Watch me code!</title>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
</head>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    height: 100%;
    width: 100%;
    font-family: sans-serif;
}

#code {
    padding: 5pt;
    margin-top: 20pt;
    height: 600px;
    max-height: 100%;
    min-height: 300px;
    width: 100%;
}
.padding {
    padding: 20pt;
}
</style>
<body>

<div class='padding'>
    <h2>Token: <span id='token'></span></h2>
    <textarea id="code" placeholder="Code here"></textarea>
</div>

<script>
    var sock_url = 'http://' + document.domain + ':' + location.port
    
    var socket = io.connect(sock_url)
    socket.on('connect', function() {
        console.log('connected.')
    })
    socket.on('disconnect', function() {
        console.log('disconnected.')
    })
    
    if ('{{ token }}'.length > 0) {
        console.log("producer")
        
        var timeout;
        document.getElementById('code').addEventListener('keyup', function(e) {
            clearTimeout(timeout)
            timeout = setTimeout(function() {
                socket.send({
                    action: 'data',
                    token: '{{ token }}',
                    data: e.target.value,
                })
            }, 250)
        })
        
        var token = document.createElement('a')
        token.href = sock_url + '/' + '{{ token }}';
        token.appendChild(document.createTextNode(document.domain + '/' + '{{token}}'))
        document.getElementById('token').appendChild(token)
    }
    else {
        console.log("subscriber")
        
        var token = window.location.pathname.slice(1)
        socket.send({
            action: 'join',
            token: token
        })
        socket.on('message', function(data) {
            document.getElementById('code').value = data;
        })
        
        document.getElementById('token').appendChild(document.createTextNode(token))
        document.getElementById('code').readOnly = true;
    }
    
</script>
</body>
</html>
